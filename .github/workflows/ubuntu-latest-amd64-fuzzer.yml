name: Dinit on ubuntu-latest-amd64 fuzzer

on:
  workflow_dispatch:

jobs:
  Ubuntu-latest-amd64_fuzzer:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Getting depends
      run: sudo apt-get update && apt-get install clang clang++ make -y
    - name: Print clang++ architecture
      run: clang++ -dumpmachine
    - name: Change current dir to `/src/tests/cptests/`
      run: cd src/tests/cptests/
    # Its step must be removed.
    # Its step is a workaround for https://github.com/davmac314/dinit.git/#91
    - name: Prepare `include` dirs
      run: mkdir -p includes && rm -rf includes/*.h && cd includes; ln -f ../../../includes/*.h . && cd .. && cd includes; ln -f ../../test-includes/dinit.h . && cd .. && cd includes; ln -f ../../test-includes/baseproc-sys.h . && cd ..
    # Its step must be removed.
    # Its step is a workaround for https://github.com/davmac314/dinit.git/#91
    - name: Generate mconfig.h
      run: cd ../../../ && make mconfig && cd build/tools && ./mconfig-gen | tee ../../src/tests/cptests/includes/mconfig.h
    - name: Build `fuzz` target via make
      run: cd ../../src/tests/cptests/ && make fuzz
    - name: Run fuzzer
      run: ./fuzz
