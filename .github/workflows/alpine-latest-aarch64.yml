name: Dinit on alpine-latest-aarch64 CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  Alpine-latest-aarch64_build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: uraimo/run-on-arch-action@v2.2.1
      name: Getting depends & build & unit tests & integration tests
      with:
        arch: aarch64
        distro: alpine_latest
        run: |
          apk add ncurses
          echo "$(tput bold) Getting depends:$(tput sgr0) apk update && apk add meson g++ m4 file"
          apk update
          apk add meson g++ m4 file
          echo "$(tput bold) Print g++ arch:$(tput sgr0) g++ -dumpmachine"
          g++ -dumpmachine
          echo "$(tput bold) Prepare Build:$(tput sgr0) meson setup -Dunit_tests=true -Digr_tests=true builddir"
          meson setup -Dunit_tests=true -Digr_tests=true builddir
          echo "$(tput bold) Prepare Build:$(tput sgr0) meson compile -C builddir"
          meson compile -C builddir
          echo "$(tput bold) Print dinit executive file architecture:$(tput sgr0) file ./builddir/src/dinit"
          file ./builddir/src/dinit
          echo "$(tput bold) Unit & Integration tests:$(tput sgr0) meson test -C builddir"
          meson test -C builddir
